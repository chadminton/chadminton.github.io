<html>
	<head>
		<title>North American Chadminton League</title>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, user-scalable=no, maximum-scale=1, minimum-scale=1" />
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="nacl.css">		
		<script src="https://www.youtube.com/player_api"></script>
		<script src="scripts/basic.js"></script>
		<script type="text/javascript">
			
			var teams, pods, cache = getLocalValue('nacl-cache') || {};
			
			var ready = function () {
				getJSONfile('nacl/league.json', function (lg) {
					teams = lg.league;
					getJSONfile('nacl/games.json', function (gm) {
						pods = gm.schedule;
						updatePage();
					});
				});
			};
			
			var setup = function (page) {
				hideAll();
				var path = page.split('/');
				var first = path[0] || 'day';
				
				switch(first) {
					case '#team':
						var id = path[1];
						var sort = path[2] || 'number';
						showTeam(id, sort);
						break;
					case '#standings':
						var conf = path[1];
						showStandings(conf);
						break;
					case '#stats':
						break;
					case '#game':
						var day = new Date(path[1]);
						var a = path[2];
						var b = path[3];
						showGameSummary(day, a, b);
						break;
					case '#day':
					default:
						var day = new Date();
						if (path.length > 1) {
							day = new Date(path[1]);
						} else {
							day.setHours(0);
							day.setMinutes(0);
							day.setSeconds(0);
						}
						showGames(day);
						break;
				}
			};                  
			
			var getTeamInfo = function (team, score) {
				var wins = team.wins || 0;
				var losses = team.losses || 0;
				var html = '<div class="team" style="background-color: ' + 
							team.color1 + '; color: ' + 
							team.color2 + '; background-image: url(\'img/teams/' +
							team.abbr + '.png\');">';
				html += '<div class="record">' + wins + '-' + losses + '</div>' +
						'<div class="city" onclick="navigate(\'#team/' + team.id + '\')">' + team.city + '</div>' +
						'<div class="name" onclick="navigate(\'#team/' + team.id + '\')">' + team.name + '</div>';
				if (!isNaN(score)) {
					html += '<div class="score">' + score + '</div>'
				}
				html += '</div>';
				return html;
			};
			
			var showGameSummary = function (day, a, b) {
				teamSortsApplied = 0;
				var t = pods.query({ date: day.toStringFormat('yyyy-MM-ddT00:00:00') });
                var guts = '';
                if (t.length == 1) {
					var gs = t[0].games.query({ a: a, b: b });
					if (gs.length == 1) {
						var game = gs[0];
						game.aScore = isNaN(game.aScore) ? '' : game.aScore;
						game.bScore = isNaN(game.bScore) ? '' : game.bScore;				
						var away = teams.getElementById(game.away == 'a' ? game.a : game.b);
						var home = teams.getElementById(game.home == 'a' ? game.a : game.b);
						var awayScore = game.away == 'a' ? game.aScore : game.bScore;
						var homeScore = game.home == 'a' ? game.aScore : game.bScore;
						var awayWinner = awayScore > homeScore ? ' winner' : '';
						var homeWinner = homeScore > awayScore ? ' winner' : '';
						
						var guts = getTeamInfo(away, awayScore) + getTeamInfo(home, homeScore) +
							'<table class="summary" cellpadding="3" cellspacing="0">' + game.log + '</table>';
						
						var gameContainer = get('#game');
						gameContainer.children[1].innerHTML = guts;
						gameContainer.style.display = 'block';
					}
				}
			};
			
			var showGames = function (day) {
				teamSortsApplied = 0;
				console.log('showing games for ' + day);
				var t = pods.query({ date: day.toStringFormat('yyyy-MM-ddT00:00:00') });
                var guts = '';
                if (t.length == 1) {
                    getFile('nacl/game-template.html', function (template) {  
                        
                        t[0].games.each(function (game) {
							// if game hasn't been played yet
							game.aScore = isNaN(game.aScore) ? '' : game.aScore;
							game.bScore = isNaN(game.bScore) ? '' : game.bScore;
							
                            var away = teams.getElementById(game.away == 'a' ? game.a : game.b);
                            var home = teams.getElementById(game.home == 'a' ? game.a : game.b);
                            var awayScore = game.away == 'a' ? game.aScore : game.bScore;
                            var homeScore = game.home == 'a' ? game.aScore : game.bScore;
							
                            guts += template.replace(/{{away-team}}/g, getTeamInfo(away))
                                    .replace(/{{home-team}}/g, getTeamInfo(home))
									.replace(/{{game-id}}/g, day.toStringFormat('M-d-yyyy') + '/' + game.a + '/' + game.b);
							if (awayScore != homeScore) {
								guts = guts.replace(/{{away-score}}/g, '<div class="away score">' + awayScore + '</div>')
										.replace(/{{home-score}}/g, '<div class="home score">' + homeScore + '</div>');
							}
							else {
								guts = guts.replace(/{{away-score}}/g, '')
										.replace(/{{home-score}}/g, '');
							}
							dayContainer.children[1].innerHTML = guts;							
                        });
                    }); 
                } else {
					guts = 'No games';
				}
						
				var headerHtml = '<a class="nav" href="javascript:changeDay(-1)">&ltrif;</a> ' + 
								 'Games for ' + day.toStringFormat('M/d/yyyy') +
								 '<a class="nav" href="javascript:changeDay(1)">&rtrif;</a>';
				
				var dayContainer = get('#day');
				dayContainer.children[0].innerHTML = headerHtml;
				dayContainer.children[1].innerHTML = guts;
				dayContainer.style.display = 'block';
			};
				
			var getPosition = function (team, player) {
				var value = '?';
				if (team.roster.offense.query({ number: player.number }).length > 0) {
					value = "Striker (S)";
				} else if (team.roster.defense.query({ number: player.number }).length > 0) {
					value = "Sweeper/Chad (W)";
				} else if (team.roster.midfield.query({ number: player.number }).length > 0) {
					value = "Defense (D)";
				} else if (team.roster.goalies.query({ number: player.number }).length > 0) {
					value = "Goalkeeper (G)";
				}
				
				return value;
			};
			
			var teamSortsApplied = 0;
			
			var showTeam = function (id, sort) {
				teamSortsApplied++;
				var team = teams.getElementById(id);
				var guts = getTeamInfo(team);
				
				var navOpen = 'style="cursor: pointer; font-weight: bold; background-color: #222; color: #fff" ' +
							  'onclick="navigate(\'#team/' + id + '/';
				var navClose = '\')"';
				
				guts += '<table style="border: none;" cellpadding="5" cellspacing="0">';
				
				guts += '<tr>' +
						'<td ' + navOpen + 'number' + navClose + '>#</td>' +
						'<td ' + navOpen + 'first' + navClose + '>first</td>' +
						'<td ' + navOpen + 'last' + navClose + '>last</td>' +
						'<td ' + navOpen + 'position' + navClose + '>position</td>' +
						'<td ' + navOpen + 'goals' + navClose + '>goals</td>' +
						'<td ' + navOpen + 'assists' + navClose + '>assists</td>' +
						'<td ' + navOpen + 'points' + navClose + '>points</td>' +
						'</tr>';
				
				team.players.sort(function (a, b) { 
					if (sort == 'position') {
						return getPosition(team, a) - getPosition(team, b);
					} else if (sort == 'points') {
						return (b.goals + b.assists) - (a.goals + a.assists);
					} else if (sort == 'goals' || sort == 'assists') {
						return parseInt(b[sort]) - parseInt(a[sort]);
					} else {
						return parseInt(a[sort]) - parseInt(b[sort]);
					}
				}).each(function (player) {
					guts += '<tr>' +
							'<td>' + player.number + '</td>' +
							'<td>' + player.first + '</td>' +
							'<td>' + player.last + '</td>' +
							'<td>' + getPosition(team, player) + '</td>' +
							'<td>' + player.goals + '</td>' +
							'<td>' + player.assists + '</td>' +
							'<td>' + (player.goals + player.assists) + '</td>' +
							'</tr>';
				});
				
				guts += '</table>';
				
				var teamContainer = get('#team-view');
				teamContainer.children[1].innerHTML = guts;
				teamContainer.children[1].style.backgroundImage = 'url(\'img/teams/' + team.abbr + '.png\')';
				teamContainer.style.display = 'block';				
			};
			
			var showStandings = function (conferenceId) {	
				teamSortsApplied = 0;			
				var guts = '<table style="border: none; font-size: 20pt;" cellpadding="5" cellspacing="0">';				
				guts += '<tr style="font-size: 12pt;">' +
						'<td></td>' +
						'<td></td>' +
						'<td>team</td>' +
						'<td>record</td>' +
						'<td>pct</td>' +
						'<td>games back</td>' +
						'</tr>';
						
				var sortFn = function (a, b) {
					return (b.wins + (b.wins / (b.wins + b.losses))) - (a.wins + (a.wins / (a.wins + a.losses)));
				};
						
				var getGamesBack = function (team) {
					var cid = team.conferenceId;
					var conf = teams.query({ conferenceId: team.conferenceId }).sort(sortFn);
					var leader = conf[0];
					var gb = ((leader.wins - team.wins) / 2) + ((team.losses - leader.losses) / 2);
					var msg = team.conference + ' ';
					if (gb == 0) {
						msg += 'LEADER';
					} else {
						msg += gb + ' gb';
					}
					return msg;
				};
						
				var teamsShow = (conferenceId ? teams.query({ conferenceId: conferenceId }) : teams.slice()).sort(sortFn);
				teamsShow.each(function(team, i) {
					if (i == 16) {
						guts += '<tr style="background-color: #888;"><td colspan="6"></td></tr>';
					}
					guts += '<tr style="background-color: ' + team.color1 + '; color: ' + team.color2 + '">' +
							'<td><img style="width: 80px;" src="img/teams/' + team.abbr + '.png"/></td>' +
							'<td>' + (i + 1) + '</td>' +
							'<td style="cursor: pointer;" onclick="navigate(\'#team/' + team.id + '\')">' + team.city + ' ' + team.name + '</td>' +
							'<td>' + team.Record + '</td>' +
							'<td>' + (team.wins / (team.wins + team.losses)).roundTo(3) + '</td>' +
							'<td style="font-size: 12pt; cursor: pointer;" onclick="navigate(\'#standings/' + team.conferenceId + '\')">' + getGamesBack(team) + '</td>' +
							'</tr>';
				});
				guts += '</table>';
				
				var container = get('#standings');
				container.children[1].innerHTML = guts;
				container.children[1].style.backgroundImage = '';
				container.style.display = 'block';		
			};
			
			var changeDay = function (delta) {
				var page = window.location.hash;
				var path = page.split('/');
				var day = new Date();
				if (path.length > 1) {
					day = new Date(path[1]);
				}
				var ticks = day.getTime() + (delta * 24 * 60 * 60 * 1000);
				var next = new Date();
				next.setTime(ticks);
				window.location.hash = '#day/' + next.toStringFormat('M-d-yyyy');
			};
			
			var navigate = function (path) {
				window.location.hash = path;
				window.event.stopPropagation();
				window.event.preventDefault();
			};
			
			var hideAll = function () {
				var divs = get('#content > div');
				divs.each(function (item) {
					item.style.display = 'none';
				});
			};
			
			var updatePage = function () {
				var page = window.location.hash;
				setup(page);
			};
			
		</script>
	</head>
	<body onload="ready()" onhashchange="updatePage()">
		<div id="top" class="nacl">
			<div class="links">
			</div>
			<div class="logo"></div>
		</div>
		<div id="content">
			<div id="day">
				<div class="header">TODAY'S GAMES</div>
				<div class="body">
				</div>
			</div>
			<div id="game">
				<div class="header"><a href="javascript:history.back()">&ltrif; BACK</a></div>
				<div class="body">
				</div>
			</div>
			<div id="team-view">
				<div class="header"><a href="javascript:history.go(0 - teamSortsApplied)">&ltrif; BACK</a></div>
				<div class="body">
				</div>
			</div>
			<div id="standings">
				<div class="header"><a href="javascript:history.back()">&ltrif; BACK</a></div>
				<div class="body">
				</div>
			</div>
		</div>
		<div id="footer">
			Chadminton &trade; 2004-2017
		</div>
	</body>
</html>